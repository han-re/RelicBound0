<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Great War</title>
    <link rel="stylesheet" href="css/2relic4.css">
    <style>
         .menuContainer {
            height: 100%;
            width: calc(var(--btn-size) * 10);
            background: rgb(0, 0, 0,0);
            border: 4px solid #8b000000;
            padding: 20px;
            text-align: center;
            color: white;
            display: block;
        }
            .settingsButton {
            width: 7.5vw;   
            height: 3vw; 
            text-align: center;
            padding: 0.2vw;
            background-image: url('https://i.ibb.co/rb2TWXL/bgbtn.png');
	        border: 2px solid #000;
            cursor: pointer;
            font-size: 1em;
            color: #ffffff;
            transition: background-color 0.3s; 
            position: fixed; 
            bottom: 2vw;
            right: 2vw;
            z-index: 1000;
        }

        .settingsButton:hover {
            text-shadow: 2px 2px #202013CC;
            color: #FFFFA0;
            border: 2px solid #ffffff;
            
            }

            #settingsScreen {
            display: none;
        }
       
    
            #settingsScreen {
            display: none;
        }

        .settingsOption {
            width: flex;
            display: flex;
            font-size: 1.5em;
            color: #ffffff;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-image: url('https://i.ibb.co/rb2TWXL/bgbtn.png');
	        border: 2px solid #000;
            transition: background-color 0.3s;
        }
            
        .settingsOption:hover {
        text-shadow: 2px 2px #202013CC;
		color: #FFFFA0;
        border: 2px solid #ffffff;
        
        }
    </style>
</head>
<body style="background-image: url('images/background.jpg')">
    <div id="fade-overlay"></div>
    <audio id="clickSound">
        <source src="audio/tapRB.MP3" type="audio/mpeg">
    </audio>
    <div id = mainMenu style="display:block">

    <header class="title">
        <h1>Relic 4</h1>
    </header>

    <main class="main">
        <section class="imageSide">
            <div class="oldBattlefield">
                <img src="images/perusing.jpeg" alt="Reading more about the Great War.">
            </div>
        </section>

        <section class="textSide">
            <div class="textBox">
                <p style="background-image: url('images/bgbtn.png')">As you advance, you notice carvings on shattered stone tablets, depicting a battle beyond imagination. The greatest superhero, wielding cosmic energy, led an army of warriors against an alien horde that sought to consume the planet. <br><br>Explosions of raw power turned the skies red, and the ground quaked beneath the weight of destruction. At the war's climax, a fearless warrior, once a hero himself, was cursed to remain in this realm—forever bound to protect the last and most powerful relic. His identity lost to time, only his duty remains.</p>
                <p style="background-image: url('images/bgbtn.png')">At the war's climax, there was one warrior who refused to fall. Once a noble champion of humanity, he fought with unmatched skill and valor, earning the title of The Eternal Blade. But when the final battle reached its peak, he was mortally wounded.<br><br>Rather than let him die, the gods of war cursed him with immortality—binding him to the battlefield, ensuring that as long as the war's relic remained, so too would he. Time eroded his name and his memories, leaving only a single purpose: to guard the Omega Sigil from all who would claim it.</p>
                <button class="choice1" onclick="playSoundAndRedirect('obtainr4.html')">Acquire Omega Sigil</button>
                <div id="settingsBtn" class="settingsButton" style="font-size: large;"> Settings</div>   

            </div>
        </section>
    </main>
</div>

<div class="menuContainer" id="settingsScreen" style = "width: 45vw;  height: 45vw;">
    <h1 class="title" style="margin-bottom: 8vw;" >SETTINGS</h1 >
<div class="settingsOption">
    <span>Music</span>
    <label class="toggleSwitch">
        <input type="checkbox" id="musicToggle">
        <span class="slider"></span>
    </label>
</div>

<div class="settingsOption" id="resumeBtn">
    <span>Resume Game</span>
</div>

<div class="settingsOption" id="backToMainMenu">
    <span>Back To Main Menu<span>  
</div>

</div>
</div>
    <script>
        function playSoundAndRedirect(url) {
            const clickSound = document.getElementById("clickSound");
            clickSound.currentTime = 0; //Restart sound if already playing
            clickSound.play();
            //Delay redirect to allow sound to play
            setTimeout(() => {
                window.location.href = url;
            }, 170);
        }

        let dbConfig = new URLSearchParams({
        hostname: 'localhost',
        username: 'sdas06',
        password: '6g5X6MLgPjfWMSBS',
        database: 'CSC1034_CW_47',
        query: ''
        });

        //this var will be use to store the default screens id before the settings screen pops up 
        //you willl have to change mainMenu according to what the id of the main block
        const mainMenu = document.getElementById('mainMenu');
        const settingsScreen = document.getElementById('settingsScreen');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const settingsBtn = document.getElementById('settingsBtn');

        // to show settings
        function showSettings() {
            mainMenu.style.display = 'none';
            settingsScreen.style.display = 'block';
        }
        
        function resumeGame() {
            mainMenu.style.display = 'block';
            settingsScreen.style.display = 'none';
        }

        settingsBtn.addEventListener('click', showSettings);


        //settings page functionality
        
        const resumeBtn = document.getElementById('resumeBtn');
        const backtoMainMenu = document.getElementById('backToMainMenu');
        
       
       async function toMainMenu(){

            const currentUrl = window.location.href;
            
            console.log("Before navigation - UserID:", sessionStorage.getItem("userId"));
            console.log("Before navigation - GameUserID:", sessionStorage.getItem("gameuserID"));
            // Save the current URL to the lastLevel column in gameTable
            console.log("Current URL:", currentUrl);
             await saveLastLevel(currentUrl);
    
            // Then redirect to the main menu
            window.location.href = 'StartPageTest.html';
        }

    
        resumeBtn.addEventListener('click', resumeGame);
        backtoMainMenu.addEventListener('click',toMainMenu);

        window.addEventListener('load', function() {
        backgroundMusic.play().catch(error => {
        console.log('Auto-play was prevented. User interaction needed to start audio.');
        // Many browsers require user interaction before playing audio
            });
        });

        // Music toggle functionality
        const musicToggle = document.getElementById('musicToggle');
        musicToggle.checked = true; // Set checked by default

        musicToggle.addEventListener('change', function() {
        if (this.checked) {
        backgroundMusic.play();
         } 

        else {
        backgroundMusic.pause();
        }
    });

// Additional function to ensure music can start after user interaction
        document.addEventListener('click', function() {
        if (musicToggle.checked && backgroundMusic.paused) {
        backgroundMusic.play();
        }
        }, {once: true});


        
async function toMainMenu() {
    // Get the current page URL

    const currentUrl = window.location.href;

    console.log(currentUrl);
    // Save the current URL to the lastLevel column in gameTable
    await saveLastLevel(currentUrl);
    
    // Then redirect to the main menu
    window.location.href = 'StartPageTest.html';
}
////////////////////////////////////////////////////////////////////////////

    async function saveLastLevel(pageUrl) {
    // Get the current gameID from session storage

    const gameId = localStorage.getItem("gameID");
    console.log(gameId);
    
    if (!gameId) {
        console.error("Cannot save last level: No active game");
        return;
    }
    
    // Create query to update the lastLevel in gameTable
        const query = `UPDATE gameTable SET lastLevel = '${pageUrl}' WHERE gameID = ${gameId}`;
        dbConfig.set('query', query);
    
        try {
        const response = await fetch('https://sdas06.webhosting1.eeecs.qub.ac.uk/dbConnector.php', {
            method: "POST",
            body: dbConfig
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log("Last level saved successfully:", pageUrl);

        } else {
            console.error("Failed to save last level:", result.message);
        }
        } catch (error) {
        console.error("Error saving last level:", error);
        }
    }
    </script>
    
</body>
</html>